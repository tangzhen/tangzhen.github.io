---
layout: post
title: "Continuous Integration"
date: 2013-08-04 20:11
comments: true
categories:
---

## 持续集成能干什么

---

在以往传统的开发中，集成往往被放在开发周期的后期--联调，这样的后果就是在开发过程中得到一个不可预知的联调阶段。联调阶段往往在传统开发模式中最为艰苦的一个阶段。

### 联调中主要问题

* 在开发初期没有考虑好的架构、接口等问题。
* 由于单独模块开发时可能使用不相同的运行环境，集成后环境不统一，造成的程序运行不稳当。

持续集成的出现，旨意解决在联调中出现问题，持续集成，将联调进行拆分，分成步骤很小的集成，分散到整个开发过程中，而不是把集成放到软件开发的末期。

### 持续集成的好处

* 由于将集成放到了每个开发周期，一旦有集成的问题，能够及时的发现，并进行修复。
* 解决频繁部署的问题，可以及时的将测试版本交由客户，从而及时得到客户的反馈，保证开发的系统确实的用户所需要的。
* 由于每次集成后构建，都可以得到一个可运行的系统，从另一方面考虑，降低了客户的资金风险。
* 持续集成过程中使用到一些自动化构建测试大大降低了工作量，虽然初期需要花比较成的时间搭建持续集成环境，但是长远考虑，这是有利的。
* 持续集成，能够将项目的当前状况，及时反馈给每一个开发者，从而降低了开发过程中的交流成本。

---

## 只维护一个源码仓库

源代码管理系统现在多用分布式的git，需要注意是：需将所有文件都放进源代码管理系统，除了代码外，还需要将相关测试脚本，配置文件，数据库Schema，安装脚本，第三方库，甚至IDE的配置文件。以确保一个原则：**任何人都可以找到一台干净的机器，做一次取出（checkout）动作，然后对系统执行一次完整的构建。**

使用同一个源码仓库的优势：

* 使得每个协同工作的worker，都能快速的获得同样的、最新的代码，保证了**集成的时效性**，并能**快速找出集成中出现的问题**。
* 在开发过程中，如果需要增加worker，一次checkout就能让其马上立即得到可行的工作环境。

---

## 使用持续集成构建

### 构建流程

![持续集成构建](http://www.infoq.com/resource/articles/ci-theory-practice/zh/resources/image1.png)

* 更新
	* 每次在编辑代码前，需要从源码仓库中更新的代码，保证本地代码和代码仓库中的代码一致，为最新代码。
* 编辑代码
	* 编辑代码完成尽量小的一个feature和对应的测试代码。
* 本地构建
	* 对修改的代码进行自测试。
* 更新
	* 再次从源码仓库中更新代码，因为在完成feature的同时，可能有其他人提交有新的代码。
* 本地构建
	* 再次本地构建，保证新从仓库中检出的代码，和自己开发的feature没有集成错误。
* 提交
	* 将代码提交到代码仓库。
* 提交构建
	* 该步骤一般可又CI系统在代码提交后自动进行构建。

在构建中，一般分为这7个步骤。在一个步骤中，一般又可划分为多个小步骤。例如编辑代码步骤，在完成一个feature的时候，一般可将这个feature进行再拆分，每完成一个更小的feature后，使用git commit到local repository，保证代码在出现问题的时候，能够方便的进行git reset。

需要注意的步骤是step 6，setp 1~5因为都是local repository的操作，在做错后可以回滚，step 6会将本地代码push到remote repository中。所以，**步骤6的前置本地构建，必须通过，通过所有测试，才能执行step 6.**

---

## 自动化build、自动化测试、自动化部署

为项目选用合适的自动化build的工具是非常有必要的。

* 可以把源码转变成一个可运行的系统这个过程简单化。
* 智能的build工具，可以检查源码之间的依赖项和修改项，选择性的编译，降低大型build的时间。
* build脚本允许在不同的情况中build不同的target。

自动化工具，可选用ant，maven，gradle等，IDE也会有对应的命令行工具，如MSBuild，xcodebuild等，当然还有一些工具如shell，PowerShell等，也会在自动化build中使用

开发者在开发时，可以使用IDE作为build工具，但是主build还是需要自动化的build工具，以保证他可以在开发服务器上运行。

* 自动化测试，极限编程（Extreme Programming）和驱动测试开发（TDD）待续。。。
* 自动化部署待续。。。

---

## 反馈和沟通

* 及时向mainline提交代码，并在CI Master上重新构建
* 保持快速build
* 让每个人都能轻易获得最新的可执行文件
* 每个人都能看到进度

以上这些步骤，都是为了一个目的：沟通。
沟通的角色有开发环节中的各个角色，以及和客户直接，每次DEV在开发完一个feature后，提交代码，在CI Master上进行重新构建，构建的结果将显示的公共的显示器上，以便于每个worker都能及时的查看到结果和进度。
保持快速build以及让每个人都能轻易获得最新的可执行文件，为了就是能够尽快从其他worker和客户那里获得反馈，保证了沟通的畅通性。

### 分阶段构建（Staged Build）

* 分离关注度不同的验证阶段。
* 构建流程可视化。
* 通过分阶段并发构建来缩短反馈周期。

构建的过程一般会耗费很长时间，可将构建工作分为多个job，并行进行构建。这点在Jenkins中可轻松完成。

---

## 其他技巧

* 在模拟生产环境中进行测试

---

#### 参考文献

* [持续集成（第二版）Martin Fowler](http://article.yeeyan.org/view/2251/94882)
* [持续集成理论和实践的新进展 肖鹏](http://www.infoq.com/cn/articles/ci-theory-practice)
